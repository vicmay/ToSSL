# ::tossl::sm2::generate

Generate an SM2 key pair for elliptic curve cryptography.

## Overview

`::tossl::sm2::generate` creates a new SM2 key pair consisting of a private key and corresponding public key. SM2 is a Chinese national standard for elliptic curve cryptography that provides both digital signature and encryption capabilities. The generated keys are returned in PEM format and can be used with other SM2 commands for signing, verification, encryption, and decryption.

## Syntax

```
tossl::sm2::generate
```

No arguments are required. The command generates a new SM2 key pair using secure random number generation.

## Example

```tcl
# Generate SM2 key pair
set private_key [tossl::sm2::generate]

# Extract public key from private key
set public_key [tossl::key::getpub -key $private_key]

# Use the key pair for signing
set data "Hello, SM2!"
set signature [tossl::sm2::sign $private_key $data]

# Verify the signature
set valid [tossl::sm2::verify $public_key $data $signature]
if {$valid} {
    puts "Signature is valid!"
} else {
    puts "Signature is invalid!"
}
```

## Return Value

- Returns the private key in PEM format as a string.
- The public key can be extracted using `::tossl::key::getpub`.
- Returns an error if key generation fails.

## Error Handling

- Returns an error if OpenSSL does not support SM2 key generation.
- Returns an error if the SM2 curve is not available.
- Returns an error if secure random number generation fails.
- Returns an error if memory allocation fails during key generation.
- Returns an error if the wrong number of arguments is provided.

## Security Considerations

- **Key Security**: Generated private keys should be kept secure and never exposed.
- **Random Number Generation**: Uses OpenSSL's secure random number generator.
- **Key Strength**: SM2 provides strong cryptographic security equivalent to 256-bit symmetric encryption.
- **Key Storage**: Store private keys securely and never transmit them over insecure channels.

## Best Practices

- Always use keys generated by secure cryptographic processes.
- Store private keys securely with appropriate access controls.
- Use different key pairs for different purposes (signing vs. encryption).
- Regularly rotate keys for long-term security.
- Do not expose private key material in logs or outputs.

## Advanced Usage

### Batch Key Generation

```tcl
# Generate multiple key pairs efficiently
proc generate_multiple_keys {count} {
    set keys {}
    for {set i 0} {$i < $count} {incr i} {
        set key [tossl::sm2::generate]
        lappend keys $key
    }
    return $keys
}

# Usage
set key_pairs [generate_multiple_keys 10]
puts "Generated [llength $key_pairs] key pairs"
```

### Key Generation with Validation

```tcl
# Generate key with immediate validation
proc generate_validated_key {} {
    set private_key [tossl::sm2::generate]
    set public_key [tossl::key::getpub -key $private_key]
    
    # Test the key pair with signing/verification
    set test_data "Key validation test"
    set signature [tossl::sm2::sign $private_key $test_data]
    set verification_result [tossl::sm2::verify $public_key $test_data $signature]
    
    if {$verification_result} {
        return [dict create \
            private $private_key \
            public $public_key \
            valid 1]
    } else {
        error "Generated key pair validation failed"
    }
}

# Usage
set key_info [generate_validated_key]
puts "Generated valid key pair"
puts "Private key length: [string length [dict get $key_info private]]"
puts "Public key length: [string length [dict get $key_info public]]"
```

### Key Generation with Analysis

```tcl
# Generate key and perform analysis
proc generate_and_analyze_key {} {
    set private_key [tossl::sm2::generate]
    set public_key [tossl::key::getpub -key $private_key]
    
    # Analyze the keys
    set private_info [tossl::key::analyze $private_key]
    set public_info [tossl::key::analyze $public_key]
    set fingerprint [tossl::key::fingerprint $private_key]
    
    return [dict create \
        private $private_key \
        public $public_key \
        private_info $private_info \
        public_info $public_info \
        fingerprint $fingerprint]
}

# Usage
set key_data [generate_and_analyze_key]
puts "Key fingerprint: [dict get $key_data fingerprint]"
puts "Private key info: [dict get $key_data private_info]"
puts "Public key info: [dict get $key_data public_info]"
```

## Performance Considerations

- **Efficient Implementation**: Uses OpenSSL's optimized SM2 implementation.
- **Memory Management**: Efficient memory allocation and cleanup.
- **Batch Processing**: Can handle multiple key generation operations efficiently.

### Performance Monitoring

```tcl
# Monitor key generation performance
proc benchmark_key_generation {iterations} {
    set start_time [clock milliseconds]
    
    for {set i 0} {$i < $iterations} {incr i} {
        set key [tossl::sm2::generate]
        if {[string length $key] == 0} {
            error "Empty key generated on iteration $i"
        }
    }
    
    set end_time [clock milliseconds]
    set total_time [expr {$end_time - $start_time}]
    set avg_time [expr {double($total_time) / $iterations}]
    
    return [dict create \
        total_time $total_time \
        average_time $avg_time \
        operations_per_second [expr {double($iterations) * 1000 / $total_time}]]
}

# Usage
set benchmark [benchmark_key_generation 20]
puts "Average key generation time: [dict get $benchmark average_time]ms"
puts "Operations per second: [format %.2f [dict get $benchmark operations_per_second]]"
```

## Integration Examples

### Key Generation in Web Applications

```tcl
# Generate keys for web application users
proc generate_user_keys {user_id} {
    set private_key [tossl::sm2::generate]
    set public_key [tossl::key::getpub -key $private_key]
    set fingerprint [tossl::key::fingerprint $private_key]
    
    # Store key information (private key should be encrypted in production)
    set key_data [dict create \
        user_id $user_id \
        private_key $private_key \
        public_key $public_key \
        fingerprint $fingerprint \
        created [clock seconds]]
    
    return $key_data
}

# Usage
set user_keys [generate_user_keys "alice@example.com"]
puts "Generated keys for user: [dict get $user_keys user_id]"
puts "Key fingerprint: [dict get $user_keys fingerprint]"
```

### Key Generation for File Encryption

```tcl
# Generate keys for file encryption system
proc generate_file_encryption_keys {} {
    set private_key [tossl::sm2::generate]
    set public_key [tossl::key::getpub -key $private_key]
    
    # Create key metadata
    set key_metadata [dict create \
        algorithm "SM2" \
        key_size 256 \
        created [clock format [clock seconds]] \
        fingerprint [tossl::key::fingerprint $private_key]]
    
    return [dict create \
        private $private_key \
        public $public_key \
        metadata $key_metadata]
}

# Usage
set encryption_keys [generate_file_encryption_keys]
puts "Generated encryption keys:"
puts "Algorithm: [dict get [dict get $encryption_keys metadata] algorithm]"
puts "Key size: [dict get [dict get $encryption_keys metadata] key_size] bits"
puts "Created: [dict get [dict get $encryption_keys metadata] created]"
```

### Secure Key Management System

```tcl
# Generate keys for secure key management
proc generate_secure_keys {purpose} {
    set private_key [tossl::sm2::generate]
    set public_key [tossl::key::getpub -key $private_key]
    
    # Create secure key record
    set key_record [dict create \
        purpose $purpose \
        private_key $private_key \
        public_key $public_key \
        fingerprint [tossl::key::fingerprint $private_key] \
        created [clock seconds] \
        expires [expr {[clock seconds] + 365*24*60*60}]]  ;# 1 year expiry
    
    return $key_record
}

# Usage
set signing_keys [generate_secure_keys "document_signing"]
set encryption_keys [generate_secure_keys "data_encryption"]

puts "Generated signing keys for: [dict get $signing_keys purpose]"
puts "Generated encryption keys for: [dict get $encryption_keys purpose]"
```

## Troubleshooting

### Common Issues

1. **"Failed to create EC context" error**
   - Ensure OpenSSL supports SM2
   - Check that SM2 curve is available

2. **"Failed to set SM2 curve" error**
   - Verify OpenSSL version supports SM2
   - Check system configuration

3. **"Failed to generate SM2 EC key" error**
   - Check system entropy sources
   - Verify OpenSSL installation

4. **"Failed to write private key" error**
   - Check memory availability
   - Verify OpenSSL configuration

### Debug Information

```tcl
# Debug key generation process
proc debug_key_generation {} {
    puts "Debug: Starting SM2 key generation..."
    
    if {[catch {
        set start_time [clock milliseconds]
        set key [tossl::sm2::generate]
        set end_time [clock milliseconds]
        
        puts "Debug: Key generation successful"
        puts "Debug: Generation time: [expr {$end_time - $start_time}]ms"
        puts "Debug: Key length: [string length $key] bytes"
        
        # Validate key format
        if {[regexp {-----BEGIN PRIVATE KEY-----} $key]} {
            puts "Debug: Key has correct PEM format"
        } else {
            puts "Debug: Key format may be incorrect"
        }
        
        return $key
    } err]} {
        puts "Debug: Key generation failed: $err"
        return ""
    }
}
```

## Key Format

SM2 keys are generated in PEM format with the following characteristics:

- **Private Key Format**: `-----BEGIN PRIVATE KEY-----` / `-----END PRIVATE KEY-----`
- **Public Key Format**: `-----BEGIN PUBLIC KEY-----` / `-----END PUBLIC KEY-----` (when extracted)
- **Encoding**: Base64-encoded DER format
- **Key Size**: 256-bit (equivalent to 128-bit symmetric security)

### Key Conversion

```tcl
# Convert key to different formats
proc convert_key_format {private_key format} {
    switch $format {
        "pem" {
            return $private_key  ;# Already in PEM format
        }
        "fingerprint" {
            return [tossl::key::fingerprint $private_key]
        }
        "public" {
            return [tossl::key::getpub -key $private_key]
        }
        "info" {
            return [tossl::key::analyze $private_key]
        }
        default {
            error "Unsupported format: $format"
        }
    }
}

# Usage
set private_key [tossl::sm2::generate]
set public_key [convert_key_format $private_key "public"]
set fingerprint [convert_key_format $private_key "fingerprint"]
set key_info [convert_key_format $private_key "info"]

puts "Public key: $public_key"
puts "Fingerprint: $fingerprint"
puts "Key info: $key_info"
```

## See Also

- `::tossl::sm2::sign` - Create SM2 digital signatures
- `::tossl::sm2::verify` - Verify SM2 digital signatures
- `::tossl::sm2::encrypt` - Encrypt data using SM2
- `::tossl::sm2::decrypt` - Decrypt data using SM2
- `::tossl::key::getpub` - Extract public key from private key
- `::tossl::key::analyze` - Analyze key properties
- `::tossl::key::fingerprint` - Generate key fingerprint
- `::tossl::ec::generate` - Generate EC key pairs
- `::tossl::rsa::generate` - Generate RSA key pairs

## Standards Compliance

- **GB/T 32918.1-2016**: Chinese national standard for SM2 elliptic curve cryptography
- **RFC 5639**: Elliptic Curve Cryptography (ECC) Brainpool Standard Curves and Curve Generation
- **OpenSSL Compatibility**: Uses OpenSSL's SM2 implementation for maximum compatibility 