# ::tossl::sm2::verify

Verify an SM2 digital signature using a public key and message.

## Overview

`::tossl::sm2::verify` checks the validity of an SM2 digital signature for a given message and public key. SM2 is a Chinese national standard for elliptic curve cryptography that provides both digital signature and encryption capabilities.

## Syntax

```
tossl::sm2::verify <public_key_pem> <data> <signature>
```

- `<public_key_pem>`: The SM2 public key in PEM format.
- `<data>`: The message string that was signed.
- `<signature>`: The signature as a binary string (output of `tossl::sm2::sign`).

## Example

```tcl
# Generate SM2 key pair
set key_pair [tossl::sm2::generate]
set private_key $key_pair
set public_key [tossl::key::getpub -key $private_key]

# Sign data
set data "Hello, SM2!"
set signature [tossl::sm2::sign $private_key $data]

# Verify signature
set valid [tossl::sm2::verify $public_key $data $signature]
if {$valid} {
    puts "Signature is valid!"
} else {
    puts "Signature is invalid!"
}
```

## Return Value

- Returns `1` (true) if the signature is valid.
- Returns `0` (false) if the signature is invalid.
- Returns an error if the public key, data, or signature is malformed.

## Error Handling

- Returns an error if the public key is not a valid SM2 or EC key with SM2 curve.
- Returns an error if the signature format is invalid.
- Returns an error if the wrong number of arguments is provided.
- Returns an error if memory allocation fails during verification.

## Security Considerations

- **Key Validation**: The command validates that the provided key is an SM2 key or an EC key using the SM2 curve.
- **Signature Integrity**: The verification process ensures that the signature was created by the holder of the corresponding private key.
- **Data Integrity**: Any modification to the signed data will cause verification to fail.
- **Cryptographic Strength**: SM2 uses elliptic curve cryptography with the SM2 curve, providing strong security.

## Best Practices

- Always verify signatures before trusting signed data.
- Use keys generated by secure cryptographic processes.
- Handle verification failures securely in your application.
- Do not expose private key material in logs or outputs.
- Validate all inputs before calling this command.

## Advanced Usage

### Batch Signature Verification

```tcl
# Verify multiple signatures efficiently
proc verify_multiple_signatures {public_key data_signature_pairs} {
    set results {}
    foreach pair $data_signature_pairs {
        lassign $pair data signature
        set valid [tossl::sm2::verify $public_key $data $signature]
        lappend results [list $data $valid]
    }
    return $results
}

# Usage
set pairs {
    {"Message 1" $sig1}
    {"Message 2" $sig2}
    {"Message 3" $sig3}
}
set verification_results [verify_multiple_signatures $public_key $pairs]
```

### Signature Validation with Error Handling

```tcl
# Robust signature verification with detailed error handling
proc verify_signature_robust {public_key data signature} {
    if {[catch {
        set result [tossl::sm2::verify $public_key $data $signature]
        return [dict create valid $result error ""]
    } err]} {
        return [dict create valid 0 error $err]
    }
}

# Usage
set verification [verify_signature_robust $public_key $data $signature]
if {[dict get $verification valid]} {
    puts "Signature verified successfully"
} else {
    puts "Verification failed: [dict get $verification error]"
}
```

### SM2 Signature Compliance Testing

```tcl
# Test SM2 signature compliance
proc test_sm2_compliance {public_key} {
    puts "=== SM2 Compliance Testing ==="
    
    # Test with various data types
    set test_cases {
        "Simple text message"
        ""
        "Binary data: [format %c 0x00][format %c 0xFF]"
        [string repeat "Long message " 100]
    }
    
    foreach test_data $test_cases {
        if {[catch {
            # This would require signing capability in the test
            # For now, we'll just test the verification interface
            puts "✓ Test case prepared: [string length $test_data] bytes"
        } err]} {
            puts "✗ Test case failed: $err"
        }
    }
    
    puts "✓ SM2 compliance testing completed"
}
```

## Performance Considerations

- **Efficient Implementation**: Uses OpenSSL's optimized SM2 implementation.
- **Memory Management**: Efficient memory allocation and cleanup.
- **Batch Processing**: Can handle multiple verification operations efficiently.

### Performance Monitoring

```tcl
# Monitor verification performance
proc benchmark_sm2_verification {public_key data signature iterations} {
    set start_time [clock milliseconds]
    
    for {set i 0} {$i < $iterations} {incr i} {
        set result [tossl::sm2::verify $public_key $data $signature]
        if {!$result} {
            error "Verification failed during benchmark"
        }
    }
    
    set end_time [clock milliseconds]
    set total_time [expr {$end_time - $start_time}]
    set avg_time [expr {double($total_time) / $iterations}]
    
    return [dict create \
        total_time $total_time \
        average_time $avg_time \
        operations_per_second [expr {double($iterations) * 1000 / $total_time}]]
}

# Usage
set benchmark [benchmark_sm2_verification $public_key $data $signature 100]
puts "Average verification time: [dict get $benchmark average_time]ms"
puts "Operations per second: [format %.2f [dict get $benchmark operations_per_second]]"
```

## Integration Examples

### SM2 Signature in Web Applications

```tcl
# Verify SM2 signatures in web application context
proc verify_web_signature {public_key_pem request_data signature_hex} {
    # Convert hex signature to binary
    set signature ""
    for {set i 0} {$i < [string length $signature_hex]} {incr i 2} {
        append signature [format %c [scan [string range $signature_hex $i [expr {$i+1}]] %x]]
    }
    
    # Verify signature
    return [tossl::sm2::verify $public_key_pem $request_data $signature]
}

# Usage in web application
set api_signature "a1b2c3d4e5f6..."
set request_body "{\"user\":\"alice\",\"action\":\"transfer\"}"
set public_key "-----BEGIN PUBLIC KEY-----\n..."

if {[verify_web_signature $public_key $request_body $api_signature]} {
    puts "API request signature verified"
    # Process the request
} else {
    puts "API request signature invalid"
    # Reject the request
}
```

### SM2 Signature in File Integrity

```tcl
# Verify file integrity using SM2 signatures
proc verify_file_integrity {public_key filename signature_file} {
    # Read file content
    set file_handle [open $filename r]
    set content [read $file_handle]
    close $file_handle
    
    # Read signature
    set sig_handle [open $signature_file r]
    set signature [read $sig_handle]
    close $sig_handle
    
    # Verify signature
    return [tossl::sm2::verify $public_key $content $signature]
}

# Usage
set file_valid [verify_file_integrity $public_key "important_document.pdf" "document.sig"]
if {$file_valid} {
    puts "File integrity verified"
} else {
    puts "File integrity check failed"
}
```

## Troubleshooting

### Common Issues

1. **"Not an SM2 or EC key" error**
   - Ensure the public key is a valid SM2 key or EC key with SM2 curve
   - Check that the key is in PEM format

2. **"Failed to parse public key" error**
   - Verify the PEM format is correct
   - Ensure the key is a public key, not a private key

3. **"Failed to initialize verification" error**
   - Check that OpenSSL supports SM2
   - Verify the key type is compatible

### Debug Information

```tcl
# Debug signature verification
proc debug_verify_signature {public_key data signature} {
    puts "Debug: Public key length: [string length $public_key]"
    puts "Debug: Data length: [string length $data]"
    puts "Debug: Signature length: [string length $signature]"
    puts "Debug: Signature binary: [string is binary $signature]"
    
    if {[catch {
        set result [tossl::sm2::verify $public_key $data $signature]
        puts "Debug: Verification result: $result"
        return $result
    } err]} {
        puts "Debug: Verification error: $err"
        return 0
    }
}
```

## See Also

- `::tossl::sm2::sign` - Create SM2 digital signatures
- `::tossl::sm2::generate` - Generate SM2 key pairs
- `::tossl::sm2::encrypt` - Encrypt data using SM2
- `::tossl::sm2::decrypt` - Decrypt data using SM2
- `::tossl::key::getpub` - Extract public key from private key
- `::tossl::ec::verify` - Verify EC digital signatures
- `::tossl::rsa::verify` - Verify RSA digital signatures

## Standards Compliance

- **GB/T 32918.1-2016**: Chinese national standard for SM2 elliptic curve cryptography
- **RFC 5639**: Elliptic Curve Cryptography (ECC) Brainpool Standard Curves and Curve Generation
- **OpenSSL Compatibility**: Uses OpenSSL's SM2 implementation for maximum compatibility 