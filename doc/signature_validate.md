# ::tossl::signature::validate

## Overview

The `::tossl::signature::validate` command validates digital signatures using public key cryptography. It verifies that a signature was created by the holder of the corresponding private key and that the signed data has not been tampered with.

**Update (2024):** The ::tossl::signature::validate command now fully supports signature verification for all supported key types (RSA, EC, etc.) and digest algorithms. It is compatible with signatures generated by ::tossl::rsa::sign, ::tossl::ec::sign, and other TOSSL signing commands. The implementation uses the OpenSSL EVP_DigestVerify* API, ensuring correct validation of signatures created by the corresponding sign commands.

## Syntax

```tcl
::tossl::signature::validate pubkey data signature algorithm
```

## Parameters

- **pubkey** - Public key in PEM format (string)
- **data** - The original data that was signed (string)
- **signature** - The signature to validate in hexadecimal format (string)
- **algorithm** - The digest algorithm used for signing (string)

## Return Value

Returns a string indicating the validation result:
- `"valid"` - The signature is valid
- `"invalid"` - The signature is invalid

## Supported Algorithms

The command supports all digest algorithms available in the OpenSSL installation:

### Common Algorithms
- `sha1` - SHA-1 (deprecated, use SHA-2 family)
- `sha224` - SHA-224
- `sha256` - SHA-256 (recommended)
- `sha384` - SHA-384
- `sha512` - SHA-512
- `sha3-224` - SHA-3 224-bit
- `sha3-256` - SHA-3 256-bit
- `sha3-384` - SHA-3 384-bit
- `sha3-512` - SHA-3 512-bit
- `blake2b512` - BLAKE2b 512-bit
- `blake2s256` - BLAKE2s 256-bit

### Legacy Algorithms
- `md5` - MD5 (deprecated, insecure)
- `ripemd160` - RIPEMD-160

## Supported Key Types

The command works with various public key types:
- **RSA** - RSA public keys (1024, 2048, 3072, 4096 bits)
- **EC** - Elliptic Curve public keys (various curves)
- **DSA** - DSA public keys
- **Ed25519** - Edwards-curve Digital Signature Algorithm
- **Ed448** - Edwards-curve Digital Signature Algorithm

## Examples

### Basic RSA Signature Validation

```tcl
# Generate RSA key pair
set private_key [::tossl::rsa::generate -bits 2048]
set public_key [::tossl::key::getpub $private_key]

# Sign some data
set data "Hello, World!"
set signature [::tossl::rsa::sign $private_key $data -digest sha256]

# Validate the signature
set result [::tossl::signature::validate $public_key $data $signature "sha256"]
puts "Signature is: $result"
# Output: Signature is: valid
```

### EC Signature Validation

```tcl
# Generate EC key pair
set private_key [::tossl::ec::generate -curve secp256r1]
set public_key [::tossl::key::getpub $private_key]

# Sign and validate
set data "Important message"
set signature [::tossl::ec::sign $private_key $data -digest sha256]
set result [::tossl::signature::validate $public_key $data $signature "sha256"]
puts "EC signature is: $result"
```

### Validating External Signatures

```tcl
# Public key from external source (PEM format)
set external_pubkey {-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
-----END PUBLIC KEY-----}

# Data and signature from external source
set signed_data "External data"
set external_signature "3045022100..."  ;# Hex format

# Validate
set result [::tossl::signature::validate $external_pubkey $signed_data $external_signature "sha256"]
if {$result eq "valid"} {
    puts "External signature verified successfully"
} else {
    puts "External signature verification failed"
}
```

### Different Digest Algorithms

```tcl
# Using SHA-512
set signature_512 [::tossl::rsa::sign $private_key $data -digest sha512]
set result_512 [::tossl::signature::validate $public_key $data $signature_512 "sha512"]

# Using SHA-384
set signature_384 [::tossl::rsa::sign $private_key $data -digest sha384]
set result_384 [::tossl::signature::validate $public_key $data $signature_384 "sha384"]

# Using SHA-3
set signature_sha3 [::tossl::rsa::sign $private_key $data -digest sha3-256]
set result_sha3 [::tossl::signature::validate $public_key $data $signature_sha3 "sha3-256"]
```

### Batch Validation

```tcl
# Validate multiple signatures
set signatures {
    {$pubkey1 $data1 $sig1 "sha256"}
    {$pubkey2 $data2 $sig2 "sha256"}
    {$pubkey3 $data3 $sig3 "sha512"}
}

foreach sig_info $signatures {
    set result [eval ::tossl::signature::validate $sig_info]
    puts "Signature validation: $result"
}
```

## Error Handling

The command will return an error in the following cases:

### Invalid Arguments
```tcl
# Wrong number of arguments
catch {::tossl::signature::validate $pubkey $data} err
puts "Error: $err"
# Output: Error: wrong # args: should be "::tossl::signature::validate pubkey data signature algorithm"
```

### Invalid Public Key
```tcl
# Invalid PEM format
catch {::tossl::signature::validate "invalid-key" $data $signature "sha256"} err
puts "Error: $err"
# Output: Error: Failed to parse public key
```

### Invalid Algorithm
```tcl
# Unsupported digest algorithm
catch {::tossl::signature::validate $pubkey $data $signature "invalid-algo"} err
puts "Error: $err"
# Output: Error: Unknown digest algorithm
```

### Invalid Signature Format
```tcl
# Non-hexadecimal signature
catch {::tossl::signature::validate $pubkey $data "not-hex" "sha256"} err
puts "Error: $err"
# Output: Error: Invalid signature format
```

## Security Considerations

### Algorithm Selection
- **Recommended**: Use SHA-256 or higher (SHA-384, SHA-512, SHA-3)
- **Avoid**: MD5, SHA-1 (deprecated due to collision vulnerabilities)
- **Consider**: SHA-3 family for new applications requiring quantum resistance preparation

### Key Management
- Ensure public keys are obtained from trusted sources
- Verify public key authenticity through certificate chains when possible
- Use appropriate key sizes (RSA ≥ 2048 bits, EC ≥ 256 bits)

### Signature Verification
- Always validate signatures before trusting signed data
- Verify the algorithm matches the expected one
- Check signature freshness/timestamp when applicable
- Implement proper error handling for validation failures

### Data Integrity
- Ensure the original data hasn't been modified
- Use the same encoding/format for data as when it was signed
- Be aware of whitespace and encoding differences

## Performance Considerations

### Algorithm Performance
- **Fastest**: SHA-256, SHA-1
- **Balanced**: SHA-384, SHA-512
- **Slower**: SHA-3 family, BLAKE2

### Key Type Performance
- **RSA**: Slower verification, especially with larger keys
- **EC**: Faster verification, smaller signatures
- **Ed25519/Ed448**: Very fast, constant-time operations

### Optimization Tips
```tcl
# Cache public keys when validating multiple signatures
set cached_pubkey [::tossl::key::parse $pem_data]

# Use appropriate key sizes
# RSA: 2048 bits for most applications, 3072+ for high security
# EC: secp256r1 for most applications, secp384r1 for high security

# Batch operations when possible
foreach signature $signature_list {
    # Validate in batch
}
```

## Best Practices

### Input Validation
```tcl
proc validate_signature_safely {pubkey data signature algorithm} {
    # Validate inputs
    if {[string length $pubkey] == 0} {
        error "Public key cannot be empty"
    }
    if {[string length $signature] == 0} {
        error "Signature cannot be empty"
    }
    if {[string length $signature] % 2 != 0} {
        error "Signature must be valid hexadecimal"
    }
    
    # Perform validation
    return [::tossl::signature::validate $pubkey $data $signature $algorithm]
}
```

### Error Handling
```tcl
proc safe_signature_validate {pubkey data signature algorithm} {
    if {[catch {::tossl::signature::validate $pubkey $data $signature $algorithm} result]} {
        # Log error for debugging
        puts stderr "Signature validation error: $result"
        return "error"
    }
    return $result
}
```

### Logging and Auditing
```tcl
proc audit_signature_validation {pubkey data signature algorithm} {
    set timestamp [clock format [clock seconds]]
    set result [::tossl::signature::validate $pubkey $data $signature $algorithm]
    
    # Log validation attempt
    puts "[$timestamp] Signature validation: $result (algorithm: $algorithm)"
    
    return $result
}
```

## Integration Examples

### Web Application Authentication
```tcl
proc verify_api_signature {api_key data signature} {
    # Get public key for API key
    set pubkey [get_api_public_key $api_key]
    
    # Validate signature
    set result [::tossl::signature::validate $pubkey $data $signature "sha256"]
    
    if {$result eq "valid"} {
        return 1  ;# Authentication successful
    } else {
        return 0  ;# Authentication failed
    }
}
```

### Document Verification
```tcl
proc verify_document_signature {document_path signature_path cert_path} {
    # Read document content
    set fd [open $document_path rb]
    set document_data [read $fd]
    close $fd
    
    # Read signature
    set fd [open $signature_path r]
    set signature [read $fd]
    close $fd
    
    # Extract public key from certificate
    set pubkey [::tossl::x509::parse $cert_path -pubkey]
    
    # Validate signature
    return [::tossl::signature::validate $pubkey $document_data $signature "sha256"]
}
```

## Related Commands

- `::tossl::rsa::sign` - Create RSA signatures
- `::tossl::rsa::verify` - Verify RSA signatures (alternative method)
- `::tossl::ec::sign` - Create EC signatures
- `::tossl::ec::verify` - Verify EC signatures (alternative method)
- `::tossl::dsa::sign` - Create DSA signatures
- `::tossl::dsa::verify` - Verify DSA signatures (alternative method)
- `::tossl::key::getpub` - Extract public key from private key
- `::tossl::key::parse` - Parse and validate key formats

## See Also

- [Digital Signature Standard (DSS)](https://csrc.nist.gov/publications/detail/fips/186/4/final)
- [RFC 3447 - PKCS #1: RSA Cryptography Specifications](https://tools.ietf.org/html/rfc3447)
- [RFC 6979 - Deterministic Usage of DSA and ECDSA](https://tools.ietf.org/html/rfc6979)
- [OpenSSL EVP_PKEY_verify documentation](https://www.openssl.org/docs/man3.0/man3/EVP_PKEY_verify.html)
